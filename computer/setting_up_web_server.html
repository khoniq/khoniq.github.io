<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" type="text/css" href="/style.css">
	<link rel="icon" type="image/x-icon" href="/pics/favicon.ico">
	<title>Webサーバーの設定</title>
</head>
<body>
	<header>
		<a href="/">主頁</a> |
		<a href="/about.html">自己紹介</a> |
		<a href="/journal">日記</a> |
		<a href="/farm">農業</a> |
		<a href="/kitchen">台所</a> |
		<a href="/computer">電算機</a> |
		<a href="/poetry">詩</a> |
		<a href="/books">本棚</a> |
		<a href="/gallery">絵</a> |
		<a href="/plant">植物</a> |
		<a href="https://git.mtkn.jp">Git</a>
	</header>
	<main>
		<article>
<h1>Webサーバーの設定</h1>
<time>2022-06-27</time>

<h2>はじめに</h2>
<p>OpenBSDでWebサーバーを公開する方法のメモ。といってもmanページが完璧なのであまり書く必要はない。ドメインのあたりの知識は適当なので間違っていたらごめんなさい。コンピュータの知識は全部独学なので多少間違った理解をしていても訂正されることがない。言葉の定義等細かいことがいいかげんになりがちである。</p>

<h2>環境</h2>
<ul>
	<li>OS: OpenBSD 7.1</li>
	<li>サーバー: httpd（OpenBSDに付属のもの）</li>
	<li>サーバー証明書: Let's Encrypt</li>
	<li>サーバー: さくらのVPS。ここではIPアドレスを<code><i>&lt;server_ip&gt;</i></code>とする。</li>
	<li>ドメイン: さくらのドメイン。ここでは<code><i>&lt;server_domain&gt;</i></code>とする。</li>
</ul>

<h2>設定の概要</h2>
<dl>
	<dt>サーバーを用意</dt>
		<dd>サーバーはウェブサイトのデータを保存し、ブラウザからアクセスされた時にそのデータを送り返すためのものである。ここではさくらのVPSを用いた。 </dd>
	<dt>ドメインの取得とDNSの設定</dt>
		<dd>インターネット上のサーバー等はIPアドレスを用いて識別されているが、数字の羅列なので人間には覚えにくい。そのためドメイン名という、好きなアルファベットの文字列をIPアドレスと紐付ける。インターネットにはこのドメイン名を用いて紐付いたサーバーと通信できるような仕組みがあり、これをDomain Name System（DNS）という。ドメインはインターネット上で利用料を支払うことで購入できる。IPアドレスとドメイン名の紐付け等DNSの設定は基本的にはドメインを購入したサイトでできるはずである。</dd>
	<dt>httpdの設定</dt>
		<dd>VPS上でサーバー用のソフトウェアを設定、起動する。</dd>
	<dt>証明書の発行と自動更新の設定</dt>
		<dd>ウェブブラウザとサーバーの間で暗号化された通信を行うために必要なものである。</dd>
	<dt>ホームページのファイルをアップロード</dt>
		<dd>ウェブページで配信したいものをVPSにアップロードする。</dd>
	<dt>接続の確認</dt>
		<dd>手元のブラウザからアクセスできることを確認。</dd>
</dl>

<h2>サーバーを用意</h2>
<p>サーバーをどこかで契約する。ここではさくらのVPSを利用。</p>

<h2>ドメインの取得とDNSの設定</h2>
<p>ドメインを好きな場所で取得してDNSを設定する。さくらのドメインではドメインコントロールパネルのゾーン情報から設定できる。ここではサブドメインなしのものと、サブドメインがwwwのものを設定した。VPSのIPアドレスはVPSのコントロールパネルから確認できる。</p>
<pre><code>HOST                    TYPE       POINTS TO            TTL
<i>&lt;server_domain&gt;</i>         A          <i>&lt;server_ip&gt;</i>          3600
www.<i>&lt;server_domain&gt;</i>     A          <i>&lt;server_ip&gt;</i>          3600</code></pre>
<p><code>HOST</code>はサーバーのFQDN。コントロールパネル上ではサブドメインの部分だけを設定すればよい。サブドメインが無い場合は<code>@</code>と記入する。<code>TYPE</code>は設定するレコードの属性でIPv4のサブドメインを設定する場合は<code>A</code>。この他、IPv6用の<code>AAAA</code>やメールサーバー用の<code>MX</code>、サーバーの別名を登録する<code>CNAME</code>等がある。<code>POINTS TO</code>はサーバーのIPアドレス。<code>TTL</code>はDNSのキャッシュの生存時間の秒数で、DNSの登録内容を変更した際にその変更が世界中のDNSサーバーに反映されるまでにかかる最大の時間である。世界中から多くのアクセスがあるサーバーの場合、DNSの登録内容を変更する前にTTLを短かくしておかないと、キャッシュが破棄されるまでアクセス不能になる。個人のウェブページではまあそんなにアクセスもないし適当でよさそう。ここでは1時間を指定した。</p>
<p>この設定が反映されれば、ドメイン名からサーバーにアクセスできるようになる。</p>
<pre><code>$ ping <i>&lt;server_domain&gt;</i>
PING <i>&lt;server_domain&gt;</i> (<i>&lt;server_ip&gt;</i>): 56 data bytes
64 bytes from <i>&lt;server_ip&gt;</i>: icmp_seq=0 ttl=243 time=38.032 ms
64 bytes from <i>&lt;server_ip&gt;</i>: icmp_seq=1 ttl=243 time=27.923 ms
^C</code></pre>

<h2>httpdの設定</h2>
<p>VPSにログインし、httpdを設定する。まずは<code>/etc/examples/</code>にある設定ファイルのサンプルを<code>/etc/</code>にコピーして必要な部分を変更する。</p>
<pre><code>$ doas cp /etc/examples/httpd.conf /etc/
vi /etc/httpd.conf</code></pre>

<pre><code># $OpenBSD: httpd.conf,v 1.22 2020/11/04 10:34:18 denis Exp $

server "<i>&lt;server_domain&gt;</i>" {
	listen on * port 80
	location "/.well-known/acme-challenge/*" {
		root "/acme"
		request strip 2
	}
	location * {
		block return 302 "https://$HTTP_HOST$REQUEST_URI"
	}
}

server "<i>&lt;server_domain&gt;</i>" {
	listen on * tls port 443
	tls {
		certificate "/etc/ssl/<i>&lt;server_domain&gt;</i>.fullchain.pem"
		key "/etc/ssl/private/<i>&lt;server_domain&gt;</i>.key"
	}
	location "/.well-known/acme-challenge/*" {
		root "/acme"
		request strip 2
	}
	location "*" {
		root "/htdocs/www.<i>&lt;server_domain&gt;</i>"
		directory auto index
	}
}</code></pre>
<p>一つ目の<code>server</code>ディレクティブは80番ポートにアクセスがあった時の設定。80番ポートは暗号化なしのアクセスなので、二つ目の<code>location</code>ディレクティブで暗号化ありの<code>https</code>の方にリダイレクトさせるようにしている。一つ目の<code>location</code>ディレクティブは<code>acme-client</code>がサーバー証明書を発行する際にアクセスされる場所である。既定値のままにしておけばよい。二つ目の<code>server</code>ディレクティブは443番ポートにアクセスがあった時の設定。<code>tls</code>ディレクティブにおいてサーバー証明書と、暗号化に利用する鍵が設定されている。これも既定値のままでいい。<code>location</code>ディレクティブはウェブサーバーにアクセスがあった時の処理である。一つ目は80番ポートと同じく<code>acme-client</code>用。二つ目はそれ以外である。<code>root</code>（ドキュメントルート）はアクセスがあったときにどこのディレクトリからファイルを探すかを決めるもので、<code>/var/www</code>からの相対パスで記述する。ここでは<code>/htdocs/www.<i>&lt;server_domain&gt;</i></code>にしたのでウェブページのデータは<code>/var/www/htdock/www.<i>&lt;server_domain&gt;</i>/</code>というディレクトリ以下に配置することになる。</p>
<p>ここで一度<code>httpd</code>を<code>-n</code>オプションを付けて実行し、設定ファイルのミスがないか確認しておく。</p>
<pre><code>$ doas httpd -n
configration OK</code></pre>

<h2>証明書の発行と自動更新の設定</h2>
<p>httpsによる暗号化に対応するため、Let's Encryptを使って証明書を発行する。OpenBSDには<code>acme-client</code>という便利なスクリプトが付いてきてほぼ全部自動でやってくれる。まずはこの<code>acme-client</code>の設定を変更して自分のドメインの証明書を取得するようにする。</p>
<pre><code>$ doas cp /etc/examples/acme-client.conf /etc/
$ doas vi /etc/acme-client.conf</code></pre>
<pre><code>#
# $OpenBSD: acme-client.conf,v 1.4 2020/09/17 09:13:06 florian Exp $
#
authority letsencrypt {
	api url "https://acme-v02.api.letsencrypt.org/directory"
	account key "/etc/acme/letsencrypt-privkey.pem"
}

authority letsencrypt-staging {
	api url "https://acme-staging-v02.api.letsencrypt.org/directory"
	account key "/etc/acme/letsencrypt-staging-privkey.pem"
}

authority buypass {
	api url "https://api.buypass.com/acme/directory"
	account key "/etc/acme/buypass-privkey.pem"
	contact "mailto:<i>&lt;your_mail_address&gt;</i>"
}

authority buypass-test {
	api url "https://api.test4.buypass.no/acme/directory"
	account key "/etc/acme/buypass-test-privkey.pem"
	contact "mailto:<i>&lt;your_mail_address&gt;</i>"
}

domain <i>&lt;server_domain&gt;</i> {
	alternative names { secure.<i>&lt;server_domain&gt;</i> }
	domain key "/etc/ssl/private/<i>&lt;server_domain&gt;</i>.key"
	domain full chain certificate "/etc/ssl/<i>&lt;server_domain&gt;</i>.fullchain.pem"
	sign with letsencrypt
}</code></pre>
<p>変更箇所は<code>contact</code>の部分のメールアドレスと、<code>domain</code>の部分のドメイン名。</p>
<p>続いて<code>acme-client</code>を実行して証明書を発行する。</p>
<pre><code>$ doas acme-client -v <i>&lt;server_domain&gt;</i></code></pre>
<p>次に<code>cron</code>を用いて証明書の自動更新を行うようにする。</p>
<pre><code>$ doas crontab -e</code></pre>
<pre><code>...
#minute hour    mday    month   wday    [flags] command
19 2 * * * acme-client -v <i>&lt;server_domain&gt;</i> && rcctl reload httpd
...
</code></pre>
<p>ここで設定した時間は適当。サーバーが暇そうな時間にする。僕のサーバーはいつも暇。</p>

<h2>ホームページのファイルのアップロード</h2>
<p>ウェブページに表示させたい内容のファイルをサーバーにアップロードする。試すだけであれば適当なファイルでいい。場所は今回の設定では<code>/var/www/htdocs/www.<i>&lt;server_domain&gt;</i>/</code>以下。ただし<code>httpd.conf</code>で<code>chroot</code>や、<code>server</code>ディレクティブの<code>location</code>ディレクティブの<code>root</code>の値を変更していれば、<code><i>&lt;chroot&gt;</i>/<i>&lt;root&gt;</i>/</code>にアップロードする。ここではテストのために適当なものを置いておく。</p>
<pre><code>$ doas mkdir /var/www/htdocs/www.<i>&lt;server_domain&gt;</i>
$ echo '&lt;h1&gt;unko&lt;/h1&gt;' | doas tee /var/www/htdocs/pub/index.html</code></pre>

<h2>接続の確認</h2>
<p>最後に<code>httpd</code>を起動して接続を確認する。まずは<code>rc.conf.local</code>に<code>httpd</code>の起動を許可するように記入。</p>
<pre><code>$ echo 'httpd_flags=' | doas tee -a /etc/rc.conf/local</code></pre>
<p>続いてrcに登録、起動。</p>
<pre><code>$ doas rcctl start httpd
$ doas rcctl enable httpd</code></pre>
<p>ブラウザでアクセスしてみる。</p>

<h2>おわりに</h2>
<p>とりあえず残したかったので書いてみたが、冒頭でも言った通り知識が曖昧であることに気づかされた。文章もいまいち分かりにくい箇所が多いがとりあえずこのまま置いておく。日記の記事ではないので気が向いたときに少しずつ改訂できればいいかな。</p>

<h2>参考文献</h2>
<ul>
	<li><a href="https://man.openbsd.org/httpd">httpd(8)</a>.Openbsd manual pages.2022-06-27閲覧</li>
	<li><a href="https://man.openbsd.org/httpd.conf">httpd.conf(5)</a>.Openbsd manual pages.2022-06-27閲覧</li>
	<li><a href="https://man.openbsd.org/acme-client">acme-crient(1)</a>.Openbsd manual pages.2022-06-27閲覧</li>
	<li><a href="https://man.openbsd.org/acme-client.conf">acme-crient.conf(5)</a>.Openbsd manual pages.2022-06-27閲覧</li>
	<li><a href="https://man.openbsd.org/crontab">crontab(1)</a>.Openbsd manual pages.2022-06-27閲覧</li>
	<li><a href="https://letsencrypt.org/">Let's Encrypt</a>.Let's Encrypt.2022-06-27閲覧</li>
	<li><a href="https://ja.wikipedia.org/wiki/Time_to_live#DNS%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AETime_to_live">Time to live</a>.Wikipedia.2022-06-27閲覧</li>
</ul>
		</article>

	</main>
	<footer>
		<address>info(at)mtkn(dot)jp</address>
		<a href="http://creativecommons.org/publicdomain/zero/1.0?ref=chooser-v1" rel="license noopener noreferrer">CC0 1.0</a>
	</footer>
</body>
</html>
