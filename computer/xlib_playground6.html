<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" type="text/css" href="/style.css">
	<link rel="icon" type="image/x-icon" href="/pics/favicon.ico">
	<title>Xlibで遊んでみる6</title>
</head>
<body>
	<header>
		<a href="/">主頁</a> |
		<a href="/about.html">自己紹介</a> |
		<a href="/journal">日記</a> |
		<a href="/farm">農業</a> |
		<a href="/kitchen">台所</a> |
		<a href="/computer">電算機</a> |
		<a href="/poetry">詩</a> |
		<a href="/books">本棚</a> |
		<a href="/gallery">絵</a> |
		<a href="/plant">植物</a> |
		<a href="https://git.mtkn.jp">Git</a>
	</header>
	<main>
		<article>
<h1>Xlibで遊んでみる6</h1>
<time>2023-01-25</time>

<p>
前回: <a href="xlib_playground5.html">Xlibで遊んでみる5</a>
</p>
<p>
言語: C言語<br />
ソースコード: <a href="https://git.mtkn.jp/xlib_playground">git</a>
</p>

<h2>ワールドマップの作成</h2>
<p>
ゲームのワールドマップを作製した。ここでは文字列として登録した。なにもないところは「<code>.</code>」、ブロックの場所は「<code>b</code>」、プレーヤーは「<code>p</code>」とした:
</p>
<pre><code>char worldmap[WORLD_WIDTH * WORLD_HEIGHT + 1] =
"................................................................................"
"................................................................................"
"................................................................................"
"................................................................................"
"................................................................................"
"........b......................................................................."
"................................................................................"
"................................................................................"
"....b..........................................................................."
"................................................................................"
"................b..............................................................."
"..........................................................b..........b.........."
"................................................................................"
".......................b........................................................"
"...........................................b...................................."
"...........................................b...................................."
"................................................................................"
"..................b............................................................."
"................................................................................"
"...........................................b...................................."
"................................................................................"
"................................................................................"
"...........................b...................................................."
"................................................................................"
"................................................................................"
"................................................................................"
"................................................................................"
"................................................................................"
"................................................................................"
"....................................bbbbbbbbbb.................................."
"................................................................................"
"................................................................................"
"................................................................................"
"................................................................................"
"................................................................................"
"................................................................................"
"..............................................bbbbbbbbbb........................"
"................................................................................"
"................................................................................"
"................................................................................"
"................................................................................"
"....................................bbbbbbbbbb.................................."
"................................................................................"
"................................................................................"
"................................................................................"
"................................................................................"
"..........................bbbbbbbbbb............................................"
"................................................................................"
"................................................................................"
"................................................................................"
"................................................................................"
"................bbbbbbbbbb......................................................"
"................................................................................"
"................................................................................"
"...p............................................................................"
"bbbbbbbbbbbbbbbbbbbbbbbbb.......bbbbbbbbbbbbbbbbbbbbbbbb...bbbbbbbbbbbbbbbbbbbbb"
"........................b.......b......................b...b...................."
"........................b.......b......................b...b...................."
"........................b.......b......................b...b...................."
"........................b.......b......................b...b....................";
</code></pre>

<h2>プレイヤーの作成</h2>
<p>プレイヤーには重力をかけたいので、まずは四角形に加速度を追加:</p>
<pre><code>struct rect {
	float ppx, ppy;
	float px, py;
	float vx, vy;
	float ax, ay;  // acceleration
	int w, h;
	int m;
};
</code></pre>
<p>ワールドマップを読み込み、その際にプレイヤーに重力を付加:</p>
<pre><code>struct rect   block[NUM_RECT];
struct rect   player;

/* ... */

	int bi = 0;
	for (int i = 0; i &lt; WORLD_WIDTH * WORLD_HEIGHT; i++) {
		if (world_map[i] == 'b') {
			block[bi].ppx = block[bi].px = i % WORLD_WIDTH * BLOCK_SIZE;
			block[bi].ppy = block[bi].py = i / WORLD_WIDTH * BLOCK_SIZE;
			block[bi].ax = 0;
			block[bi].ay = 0;
			block[bi].vx = 0;
			block[bi].vy = 0;
			block[bi].w = block[bi].h = BLOCK_SIZE;
			block[bi].m = block[bi].w * block[bi].h;
			bi++;
		} else if (world_map[i] == 'p') {
			player.ppx = player.px =  i % WORLD_WIDTH * BLOCK_SIZE;
			player.ppy = player.py = i / WORLD_WIDTH * BLOCK_SIZE;
			player.vx = 0;
			player.vy = 0;
			player.ax = 0;
			player.ay = GRAVITY;
			player.w = player.h = BLOCK_SIZE;
			player.m = player.w * player.h;
		}
	}
</code></pre>

<p>ユーザーからの入力を受けとり、プレイーヤの加速度等を変更。<code>A</code>、<code>D</code>でそれぞれ左右に加速し、地面に接しているときに<code>space</code>キーでジャンプさせる:
</p>
<pre><code>void
handle_inputs(int key_state[])
{
	if (key_state[KEY_Q] == KEY_DOWN){
		next_menu = GAME_OVER;
		return;
	}
	if (key_state[KEY_D] == KEY_DOWN) {
		if (player.vx &gt; 0) {
			player.ax = 500;
		} else {
			player.ax = 1000;
		}
	} else if (key_state[KEY_A] == KEY_DOWN) {
		if (player.vx &gt; 0) {
			player.ax = -1000;
		} else {
			player.ax = -500;
		}
	} else {
		if (player_is_falling)
			player.ax = -player.vx;
		else
			player.ax = -3 * player.vx;
	}

	if (player.vx &lt; -200) player.vx = -200;
	if (player.vx &gt; 200) player.vx = 200;
	if (!player_is_falling && key_state[KEY_SPACE] == KEY_DOWN)
		player.vy = -450;
}
</code></pre>

<p>変更した加速度は<code>rect_next_tick()</code>関数で次の位置を計算するのに使用。また画面の下に落ちた時にゲームオーバーになるように設定:</p>
<pre><code>void
rect_next_tick(struct rect *s, long ndt) // nano second
{
	s-&gt;ppx = s-&gt;px;
	s-&gt;ppy = s-&gt;py;
	s-&gt;vx += s-&gt;ax * ndt / 1000 / 1000 / 1000;
	s-&gt;vy += s-&gt;ay * ndt / 1000 / 1000 / 1000;
	s-&gt;px += s-&gt;vx * ndt / 1000 / 1000 / 1000;
	s-&gt;py += s-&gt;vy * ndt / 1000 / 1000 / 1000;

	// bind within the window
	if (s-&gt;px &lt; 0) {
		s-&gt;px = 0;
		//s-&gt;vx *= -1;
	}
	if (win_width &lt; s-&gt;px + s-&gt;w) {
		s-&gt;px = win_width - s-&gt;w;
		//s-&gt;vx *= -1;
	}
	// game over when fall out of the screen
	if (s-&gt;py &gt; win_height)
		next_menu = GAME_OVER;
}
</code></pre>


<h2>完成品</h2>
<p>
<a href="https://git.mtkn.jp/xlib_playground/file/ex6/ex6.c.html">git</a>
</p>
<p>
<video controls>
<source src="videos/ex6.webm" type="video/webm">
</video>
</p>

<h2>参考</h2>
<ul>
<li><a href="https://tronche.com/gui/x/xlib/">The Xlib Manual(html conversion)</a></li>
</ul>
		</article>

	</main>
	<footer>
		<address>info(at)mtkn(dot)jp</address>
		<a href="http://creativecommons.org/publicdomain/zero/1.0?ref=chooser-v1" rel="license noopener noreferrer">CC0 1.0</a>
	</footer>
</body>
</html>
