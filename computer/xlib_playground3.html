<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" type="text/css" href="/style.css">
	<link rel="icon" type="image/x-icon" href="/pics/favicon.ico">
	<title>Xlibで遊んでみる3</title>
</head>
<body>
	<header>
		<a href="/">主頁</a> |
		<a href="/about.html">自己紹介</a> |
		<a href="/journal">日記</a> |
		<a href="/farm">農業</a> |
		<a href="/kitchen">台所</a> |
		<a href="/computer">電算機</a> |
		<a href="/poetry">詩</a> |
		<a href="/books">本棚</a> |
		<a href="/gallery">絵</a> |
		<a href="/plant">植物</a> |
		<a href="https://git.mtkn.jp">Git</a>
	</header>
	<main>
		<article>
<h1>Xlibで遊んでみる3</h1>
<time>2023-01-02</time>

<p>
前回: <a href="xlib_playground2.html">Xlibで遊んでみる2</a>
</p>
<p>
言語: C言語<br />
ソースコード: <a href="https://git.mtkn.jp/xlib_playground">git</a>
</p>

<h2>画面サイズの変更</h2>
<p>
画面サイズが変更された時に表示している四角形が画面の外側に出ないようにした。<code>XGetWindowAttributes()</code>で画面の情報を取得し、グローバル変数の<code>win_width</code>と<code>win_height</code>に幅と高さをそれぞれ代入して<code>next_tick()</code>で四角形の位置を画面に収まるようにしている:
</p>
<pre><code>int win_width, win_height;

void
receive_events(int key_state[])
{
	XEvent event;
	XWindowAttributes wattr;

	while (XPending(display) &gt; 0) {
		XNextEvent(display, &event);
		switch (event.type) {
		case Expose: {
			XGetWindowAttributes(display, window, &wattr);
			win_width = wattr.width;
			win_height = wattr.height;
		} break;
		/* ... */
		}
	}
}

void
next_tick(long ndt) // nano second
{
	px = px + vx * ndt / 1000 / 1000 / 1000;
	py = py + vy * ndt / 1000 / 1000 / 1000;
	// bind within the window
	if (px &lt; 0)
		px = 0;
	if (win_width &lt; px + width)
		px = win_width - width;
	if (py &lt; 0)
		py = 0;
	if (win_height &lt; py + height)
		py = win_height - height;
}
</code></pre>

<h2>メニュー画面の実装</h2>
<p>
ゲームのようなものを作るうえでメニュー画面とその推移が必要である。ここではグローバル変数<code>next_menu</code>に現在のメニューを保存することにした。それぞれのメニューはそれぞれ関数として記述し、他のメニューに推移する必要が生じたときに<code>next_menu</code>を変更するようにした:
</p>
<pre><code>enum next_menu {
	START_MENU,
	GAME_PLAY,
	GAME_OVER,
	QUIT,
};

int next_menu = START_MENU;

void
start_menu(void)
{
	XEvent event;
	char *menu_char_q = "press q to quit.";
	char *menu_char_s = "press &lt;space&gt; to start.";

	XClearArea(display, window,
			   0, 0,                  // position
			   win_width, win_height, // width and height
			   False);
	XDrawString(display, window, gc,
				win_width/2 - strlen(menu_char_q)/2, win_height/2,
				menu_char_q, strlen(menu_char_q));
	XDrawString(display, window, gc,
				win_width/2 - strlen(menu_char_s)/2, win_height/2 + 20,
				menu_char_s, strlen(menu_char_s));

	while (next_menu == START_MENU) {
		XNextEvent(display, &event);
		switch (event.type) {
		case Expose: {
			XDrawString(display, window, gc,
						win_width/2 - strlen(menu_char_q)/2,
						win_height/2,
						menu_char_q, strlen(menu_char_q));
			XDrawString(display, window, gc,
						win_width/2 - strlen(menu_char_s)/2,
						win_height/2 + 20,
						menu_char_s, strlen(menu_char_s));

		} break;
		case KeyPress: {
			switch (XLookupKeysym(&event.xkey, 0)) {
			case 'q':
				next_menu = QUIT;
				break;
			case ' ':
				next_menu = GAME_PLAY;
				break;
			default:
				break;
			}
		} break;
		case ClientMessage: {
			if ((Atom) event.xclient.data.l[0] == wm_delete_window) {
				next_menu = QUIT;
			}
		} break;
		default:
			break;
		}
	}
}

int
main(void)
{
	setup();
	while (next_menu != QUIT){
		switch (next_menu){
		case START_MENU:
			start_menu();
			break;
		case GAME_PLAY:
			game_play();
			break;
		case GAME_OVER:
			game_over();
			break;
		default:
			break;
		}
	}

	cleanup();
	return 0;
}
</code></pre>
<p><code>main()</code>関数がめっちゃすっきりした。</p>

<h2>完成品</h2>
<p>
<a href="https://git.mtkn.jp/xlib_playground/file/ex3/ex3.c.html">git</a>
</p>
<p>
<video controls>
<source src="videos/ex3.webm" type="video/webm">
</video>
</p>

<h2>参考</h2>
<ul>
<li><a href="https://tronche.com/gui/x/xlib/">The Xlib Manual(html conversion)</a></li>
</ul>
<p>
次の記事: <a href="xlib_playground4.html">Xlibで遊んでみる4</a>
</p>
		</article>

	</main>
	<footer>
		<address>info(at)mtkn(dot)jp</address>
		<a href="http://creativecommons.org/publicdomain/zero/1.0?ref=chooser-v1" rel="license noopener noreferrer">CC0 1.0</a>
	</footer>
</body>
</html>
